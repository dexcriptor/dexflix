<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DexFlix</title>
<!-- Tailwind CSS for styling --><script src="https://cdn.tailwindcss.com"></script>
<!-- Google Fonts for the Netflix look --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="https://dexflix.online/favicon.ico">

<style>
/* Custom styles to perfect the Netflix look */
body {
    background-color: #141414;
    font-family: 'Inter', sans-serif;
}
    
/* Hides the scrollbar but allows scrolling in movie rows */
.scrollbar-hide::-webkit-scrollbar {
    display: none;
}
.scrollbar-hide {
    -ms-overflow-style: none; /* IE and Edge */
    scrollbar-width: none; /* Firefox */
}
/* Creates the fade-out effect at the bottom of the banner */
.banner-fade-bottom {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 7.4rem;
    background-image: linear-gradient(180deg, transparent, rgba(37,37,37,.61), #141414);
}
/* Styles for the scroll arrows on movie rows */
.scroll-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    border-radius: 9999px; /* fully rounded */
    width: 2.5rem; /* 40px */
    height: 2.5rem; /* 40px */
}
.row-container:hover .scroll-arrow {
    opacity: 1;
}
.scroll-arrow.left {
    left: 0.5rem;
}
.scroll-arrow.right {
    right: 0.5rem;
}
/* Added skeleton loading animation */
@keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
}
.skeleton {
    background-color: #333;
    background-image: linear-gradient(to right, #333 0%, #444 20%, #333 40%, #333 100%);
    background-repeat: no-repeat;
    background-size: 2000px 100%;
    animation: shimmer 1.5s infinite linear;
    border-radius: 0.25rem;
}

/* Pre-loader styles */
#preloader {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #141414;
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
    visibility: visible;
    opacity: 1;
}

#preloader.hidden {
    opacity: 0;
    visibility: hidden;
}

.loader {
    border: 8px solid #333; /* Darker grey for the track */
    border-top: 8px solid #E50914; /* Netflix red for the spinner */
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Banner Carousel Styles */
#banner {
    transition: background-image 1s ease-in-out;
}

.banner-dot {
    width: 10px;
    height: 10px;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.3s ease-in-out;
}

.banner-dot.active {
    background-color: white;
    transform: scale(1.2);
}

/* NEW: Styles for the Continue Watching remove button */
.remove-cw-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 9999px;
    width: 1.75rem;
    height: 1.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
    transform: scale(0.8);
    cursor: pointer;
    z-index: 20;
}

.group:hover .remove-cw-btn {
    opacity: 1;
    transform: scale(1);
}

.remove-cw-btn:hover {
    background-color: rgba(229, 9, 20, 0.9); /* Netflix Red on hover */
}
</style>
</head>
    
<body class="text-white">

<!-- Pre-loader --><div id="preloader">
    <div class="loader"></div>
</div>

<!-- Navbar: Stays at the top --><nav id="navbar" class="fixed top-0 left-0 right-0 z-50 p-4 transition-colors duration-500">
    <div class="flex justify-between items-center">
        <div class="flex items-center space-x-4">
            <div>
                <a href="index.html" class="no-underline hover:opacity-80 transition">
                    <img src="https://dexflix.online/logo-dexflix-v4.png" alt="DexFlix Logo" class="h-12 w-auto">
                </a>
            </div>
        </div>
        <div class="flex items-center space-x-1 md:space-x-4">
              <!-- Search Form --><form id="search-form" class="relative hidden flex items-center md:flex items-center bg-black bg-opacity-70 border border-gray-600 rounded-full">
                  <input type="search" id="search-input" placeholder="Search..." class="bg-transparent px-3 py-1 w-36 md:w-48 focus:outline-none transition-all duration-300">
                  <button type="submit" class="p-1 text-gray-400 hover:text-white" aria-label="Submit search">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                      </svg>
                  </button>
              </form>
              <!-- Mobile Search Toggle --><button id="search-toggle-btn" class="p-1 text-gray-200 hover:text-white md:hidden" aria-label="Toggle search bar">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 28 28" fill="currentColor">
                      <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                  </svg>
              </button>
        
        </div>
    </div>
</nav>

<!-- Banner Section: The big featured movie at the top --><header id="banner" class="relative text-white object-cover bg-cover bg-center" style="height: 56.25vw; max-height: 800px;">
    <!-- FIX: Added relative and z-10 to ensure content is above the fade effect, making buttons clickable --><div id="banner-content-wrapper" class="relative z-10 transition-opacity duration-500">
        <div class="ml-4 md:ml-8 pt-32 sm:pt-48 md:pt-56 h-full">
            <h1 id="banner-title" class="text-xl sm:text-3xl md:text-6xl font-extrabold pb-2"></h1>
            <div class="flex space-x-2 my-4">
                <button id="banner-play-btn" aria-label="Play banner movie" class="bg-white text-black font-bold rounded px-3 sm:px-4 md:px-8 py-1 sm:py-1.5 md:py-2 hover:bg-gray-300 transition text-xs sm:text-sm md:text-base flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Play
                </button>
                <button id="banner-info-btn" aria-label="More information about banner movie" class="bg-gray-500 bg-opacity-70 text-white font-bold rounded px-3 sm:px-4 md:px-8 py-1 sm:py-1.5 md:py-2 hover:bg-gray-600 transition text-xs sm:text-sm md:text-base">
                    More Info
                </button>
            </div>
            <!-- FIX: Moved dots here and updated classes for proper layout --><!-- Decreased mb-4 to mb-2 for less spacing --><div id="banner-dots" class="flex space-x-2 mb-2">
                <!-- Dots will be inserted here by JS --></div>
            <!-- Decreased pt-4 to pt-2 for less spacing --><p id="banner-description" class="w-11/12 sm:max-w-sm md:max-w-md lg:max-w-lg pt-2 text-xs md:text-sm h-24 leading-snug" ></p>
        </div>
    </div>

    <div class="banner-fade-bottom"></div>
    
</header>


<!-- Movie Rows: Container for all the movie carousels --><main id="movie-rows" class="relative pt-8 md:pt-12 px-4 md:px-10 pb-16">
    <!-- NEW: Continue Watching row will be injected here by JS if it exists --><!-- Rows will be dynamically added here by JavaScript --><!-- Skeleton loaders will be shown initially --></main>

<!-- Fullscreen Player Modal --><div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-95 z-[100] flex flex-col items-center p-4 sm:p-6 h-screen">
    <!-- Close button --><button id="modal-close-btn" class="absolute top-5 left-5 text-white bg-black bg-opacity-50 rounded-full h-10 w-10 flex items-center justify-center z-20 hover:bg-opacity-75 transition" aria-label="Close modal">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </button>

    <!-- Player Wrapper --><div id="player-wrapper" class="relative md:w-3/5 w-full aspect-video max-w-6xl">
        <iframe id="youtube-player" class="absolute top-0 left-0 w-full h-full" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        <iframe id="vidsrc-player" class="hidden absolute top-0 left-0 w-full h-full" frameborder="0" allow="autoplay; encrypted-media; fullscreen; picture-in-picture" allowfullscreen allowscripts="true" allow-same-origin="true"></iframe>
    </div>

    <!-- Fullscreen Button Container --><div class="w-full max-w-6xl flex justify-center">
        <button id="fullscreen-btn" class="mt-2 text-white bg-zinc-700 hover:bg-zinc-600 font-bold rounded px-4 py-2 transition text-sm flex items-center" aria-label="Toggle fullscreen">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5" />
            </svg>
            Full Screen
        </button>
    </div>

    <!-- Details Overlay --><div id="modal-details" class="w-full max-w-6xl pt-4 flex-grow flex flex-col md:flex-row md:gap-8 overflow-hidden">
        <!-- Left Column: Info --><div class="md:w-2/3 flex flex-col">
            <h2 id="modal-title" class="text-2xl md:text-4xl font-bold"></h2>
            <div id="modal-meta-info" class="flex items-center space-x-4 text-sm text-zinc-400 mt-2">
                <span id="modal-rating" class="font-semibold text-green-400"></span>
                <span id="modal-release-date"></span>
                <span id="modal-runtime"></span>
            </div>
            <p id="modal-description" class="text-sm mt-4 text-zinc-300 flex-grow overflow-y-auto scrollbar-hide pr-4"></p>
        </div>

        <!-- Right Column: Controls --><div class="md:w-1/3 mt-4 md:mt-0">
            <!-- TV Show Season/Episode Selectors --><div id="tv-selector-container" class="hidden mb-4 grid grid-cols-2 gap-3">
                <div>
                    <label for="season-select" class="text-sm font-semibold text-zinc-400">Season</label>
                    <select id="season-select" class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-red-600"></select>
                </div>
                <div>
                    <label for="episode-select" class="text-sm font-semibold text-zinc-400">Episode</label>
                    <select id="episode-select" class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-red-600"></select>
                </div>
            </div>
            <div class="flex flex-wrap gap-2" id="modal-actions">
                <!-- Action buttons (Trailer, Servers) will be injected here --></div>
            <div id="server-info" class="mt-3 text-xs text-zinc-500">
                <p>Click a "Server" to play the full video. If the video doesn't play, try another server.</p>
            </div>
        </div>
    </div>
</div>

<script>
// =================================================================================
// --- CODE REVIEW & SUGGESTIONS ---
// =================================================================================
//
// Hi there! I've added the "Continue Watching" feature you requested. Here's a
// quick rundown of the changes:
//
// --- 1. NEW FEATURE: Continue Watching ---
// I'm using your browser's `localStorage` to save items you've watched.
//
// HOW IT WORKS:
//   - When you click a "Server" button in the modal, the movie or TV show is
//     saved to your "Continue Watching" list.
//   - On page load, the app checks for this list and, if it exists, creates a
//     new row at the very top of the page.
//   - The list is sorted by most recently watched.
//   - You can remove any item from the list by hovering over it and clicking the
//     "X" button that appears.
//
// --- 2. SECURITY REMINDER ---
// Your API key is still visible on the client-side. For a real-world application,
// it's very important to move API requests to a backend proxy to protect your key.
//
// --- 3. ACCESSIBILITY (a11y) & UX ---
// The accessibility and UX improvements from the previous version (like keyboard
// navigation for posters and the "Clear Search" button) have been maintained.
//
// Enjoy the new feature!
//
// =================================================================================


// --- IMPORTANT SECURITY NOTE ---
// This API key is visible on the client-side. For a production application,
// it's crucial to hide this key by using a backend proxy server to make API requests.
const API_KEY = 'cb1a56920d7eb6a09e31003b28d7daa9';

// --- PERFORMANCE NOTE ---
// Using '/original/' images can be slow. Switched to '/w500/' for posters
// and '/w1280/' for backdrops for a better balance of quality and speed.
const IMAGE_BASE_URL_POSTER = 'https://image.tmdb.org/t/p/w500/';
const IMAGE_BASE_URL_BACKDROP = 'https://image.tmdb.org/t/p/w1280/';

// API endpoints for different movie categories
const requests = {
    fetchNetflixOriginals: `/discover/tv?api_key=${API_KEY}&with_networks=213`,
    fetchTrending: `/trending/all/week?api_key=${API_KEY}&language=en-US`,
    fetchTopRated: `/movie/top_rated?api_key=${API_KEY}&language=en-US`,
    fetchActionMovies: `/discover/movie?api_key=${API_KEY}&with_genres=28`,
    fetchComedyMovies: `/discover/movie?api_key=${API_KEY}&with_genres=35`,
    fetchHorrorMovies: `/discover/movie?api_key=${API_KEY}&with_genres=27`,
    fetchRomanceMovies: `/discover/movie?api_key=${API_KEY}&with_genres=10749`,
    fetchSciFiMovies: `/discover/movie?api_key=${API_KEY}&with_genres=878`,
    fetchThrillerMovies: `/discover/movie?api_key=${API_KEY}&with_genres=53`,
    fetchAnimationMovies: `/discover/movie?api_key=${API_KEY}&with_genres=16`,
    fetchTvShows: `/discover/tv?api_key=${API_KEY}&with_genres=10759`,
    fetchDocumentaries: `/discover/movie?api_key=${API_KEY}&with_genres=99`,
};

// --- SERVER CONFIGURATION ---
const SERVERS = [
    { 
        name: "Server 1", 
        getUrl: (type, id, s, e) => `https://player.videasy.net/${type}/${id}${type === 'tv' ? `/${s}/${e}` : ''}` 
    },
    { 
        name: "Server 2", 
        getUrl: (type, id, s, e) => type === 'tv' ? `https://moviesapi.club/tv/${id}-${s}-${e}` : `https://moviesapi.club/movie/${id}` 
    },
    { 
        name: "Server 3", 
        getUrl: (type, id, s, e) => `https://vidsrc.to/embed/${type}/${id}${type === 'tv' ? `/${s}/${e}` : ''}` 
    }
];
let activeServerIndex = 0; // Default to Server 1

// --- DOM ELEMENT SELECTORS ---
const movieRowsContainer = document.getElementById('movie-rows');
const modalOverlay = document.getElementById('modal-overlay');
const modalCloseBtn = document.getElementById('modal-close-btn');
const youtubePlayer = document.getElementById('youtube-player');
const vidsrcPlayer = document.getElementById('vidsrc-player');
const banner = document.getElementById('banner');
const logo = document.querySelector('nav a');
const searchForm = document.getElementById('search-form');
const searchInput = document.getElementById('search-input');
const searchToggleBtn = document.getElementById('search-toggle-btn');
const bannerContentWrapper = document.getElementById('banner-content-wrapper');
const bannerDotsContainer = document.getElementById('banner-dots');

// --- BANNER CAROUSEL STATE ---
let bannerCarouselMovies = [];
let currentBannerIndex = 0;
let bannerInterval;

// --- CONTINUE WATCHING STATE ---
const CW_LOCAL_STORAGE_KEY = 'dexflixContinueWatching';

// --- CORE FUNCTIONS ---
async function fetchData(endpoint) {
    try {
        const response = await fetch(`https://api.themoviedb.org/3${endpoint}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        return data.results;
    } catch (error) {
        console.error("Error fetching data:", error);
        return null; // Return null on error to handle it downstream
    }
}

async function fetchMovieDetails(movieId, mediaType) {
    const type = mediaType === 'tv' ? 'tv' : 'movie';
    try {
        const url = `https://api.themoviedb.org/3/${type}/${movieId}?api_key=${API_KEY}&language=en-US&append_to_response=videos`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch details');
        return await response.json();
    } catch (error) {
        console.error("Error fetching movie details:", error);
        return null;
    }
}

async function fetchSeasonDetails(tvId, seasonNumber) {
    try {
        const url = `https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${API_KEY}&language=en-US`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch season details');
        return await response.json();
    } catch (error) {
        console.error("Error fetching season details:", error);
        return null;
    }
}

function createMovieRow(title, moviesPromise, options = {}) {
    const { isLarge = false, isContinueWatching = false, prepend = false } = options;

    const rowId = `row-${title.replace(/\s+/g, '-').toLowerCase()}`;
    const row = document.createElement('div');
    row.className = 'my-8';
    row.id = rowId;

    const rowTitle = document.createElement('h2');
    rowTitle.className = 'text-xl md:text-2xl font-bold mb-4 mt-10';
    rowTitle.textContent = title;
    row.appendChild(rowTitle);

    const rowContainer = document.createElement('div');
    rowContainer.className = 'relative row-container';
    row.appendChild(rowContainer);

    const postersContainer = document.createElement('div');
    postersContainer.className = 'flex overflow-y-hidden overflow-x-scroll p-2 -ml-2 scrollbar-hide';
    rowContainer.appendChild(postersContainer);
    
    // Add skeleton loaders only for network-fetched rows
    if (!isContinueWatching) {
        for (let i = 0; i < 10; i++) {
            const skeleton = document.createElement('div');
            skeleton.className = `flex-shrink-0 skeleton ${isLarge ? 'w-40 h-60 sm:w-48 sm:h-72' : 'w-48 h-28 sm:w-56 sm:h-32'} mr-3 rounded`;
            postersContainer.appendChild(skeleton);
        }
    }
    
    if (prepend) {
        movieRowsContainer.prepend(row);
    } else {
        movieRowsContainer.appendChild(row);
    }
    
    // Fetch data and replace skeletons
    return moviesPromise.then(movies => {
        postersContainer.innerHTML = ''; // Clear skeletons or initial state
        
        if (!movies || movies.length === 0) {
            row.remove(); // Remove the row completely if there are no movies
            return;
        }

        movies.forEach(movie => {
            const imagePath = isLarge ? movie.poster_path : (movie.backdrop_path || movie.poster_path);
            if (!imagePath) return;

            const movieItemContainer = document.createElement('div');
            const itemWidth = isLarge ? 'w-40 sm:w-48' : 'w-48 sm:w-56';
            movieItemContainer.className = `${itemWidth} mr-3 flex-shrink-0 group relative`; // Added relative for button positioning
            
            const clickableWrapper = document.createElement('div');
            clickableWrapper.className = 'cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-500 rounded';
            clickableWrapper.setAttribute('role', 'button');
            clickableWrapper.setAttribute('tabindex', '0');
            clickableWrapper.dataset.movieId = movie.id;
            // NEW: Ensure media_type is stored correctly for Continue Watching items
            clickableWrapper.dataset.mediaType = movie.media_type || (title.toLowerCase().includes('tv') || title.toLowerCase().includes('series') || isLarge ? 'tv' : 'movie');

            clickableWrapper.addEventListener('click', handlePosterClick);
            clickableWrapper.addEventListener('keydown', handlePosterKeyPress);

            const poster = document.createElement('img');
            poster.src = `${isLarge ? IMAGE_BASE_URL_POSTER : IMAGE_BASE_URL_BACKDROP}${imagePath}`;
            poster.alt = `Poster for ${movie.name || movie.title || 'Movie'}`;
            poster.loading = 'lazy';
            
            const placeholderImageUrl = `https://placehold.co/${isLarge ? '200x300' : '300x170'}/141414/FFFFFF?text=No+Image`;
            poster.onerror = function() {
                this.onerror=null; 
                this.src=placeholderImageUrl;
            };

            const itemHeight = isLarge ? 'h-60 sm:h-72' : 'h-28 sm:h-32';
            poster.className = `object-cover w-full ${itemHeight} rounded transition-transform duration-300 group-hover:scale-105`;

            const movieTitle = document.createElement('p');
            movieTitle.className = 'mt-1 text-xs text-center text-gray-300 group-hover:text-white transition-colors duration-300 px-1 whitespace-nowrap overflow-hidden text-ellipsis';
            const titleText = movie.name || movie.title || movie.original_name;
            movieTitle.textContent = titleText;
            movieTitle.title = titleText; // Add a tooltip for the full title

            clickableWrapper.appendChild(poster);
            movieItemContainer.appendChild(clickableWrapper);
            movieItemContainer.appendChild(movieTitle);
            
            // NEW: Add remove button for Continue Watching row
            if (isContinueWatching) {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-cw-btn';
                removeBtn.setAttribute('aria-label', `Remove ${titleText} from Continue Watching`);
                removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`;
                removeBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent modal from opening
                    removeFromContinueWatching(movie.id);
                    movieItemContainer.remove(); // Remove the item from the DOM
                    // If the row is now empty, remove the entire row
                    if (postersContainer.childElementCount === 0) {
                        row.remove();
                    }
                };
                movieItemContainer.appendChild(removeBtn);
            }
            
            postersContainer.appendChild(movieItemContainer);
        });

        // Only add scroll arrows if there's overflow
        if (postersContainer.scrollWidth > postersContainer.clientWidth) {
            const leftArrow = document.createElement('button');
            leftArrow.className = 'scroll-arrow left';
            leftArrow.setAttribute('aria-label', 'Scroll left');
            leftArrow.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>`;
            leftArrow.addEventListener('click', () => postersContainer.scrollBy({ left: -window.innerWidth * 0.8, behavior: 'smooth' }));
            rowContainer.appendChild(leftArrow);

            const rightArrow = document.createElement('button');
            rightArrow.className = 'scroll-arrow right';
            rightArrow.setAttribute('aria-label', 'Scroll right');
            rightArrow.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>`;
            rightArrow.addEventListener('click', () => postersContainer.scrollBy({ left: window.innerWidth * 0.8, behavior: 'smooth' }));
            rowContainer.appendChild(rightArrow);
        }
    });
}

// --- NEW: CONTINUE WATCHING FUNCTIONS ---
function getContinueWatchingList() {
    const list = localStorage.getItem(CW_LOCAL_STORAGE_KEY);
    return list ? JSON.parse(list) : [];
}

function addToContinueWatching(movieDetails, mediaType) {
    let list = getContinueWatchingList();
    
    // Remove if it already exists to move it to the front
    list = list.filter(item => item.id !== movieDetails.id);

    const watchItem = {
        id: movieDetails.id,
        title: movieDetails.title || movieDetails.name,
        poster_path: movieDetails.poster_path,
        backdrop_path: movieDetails.backdrop_path,
        media_type: mediaType,
        watchedAt: new Date().getTime() // Timestamp for sorting
    };

    list.unshift(watchItem); // Add to the beginning of the list

    // Keep the list from getting too long (e.g., max 20 items)
    if (list.length > 20) {
        list.pop();
    }
    
    localStorage.setItem(CW_LOCAL_STORAGE_KEY, JSON.stringify(list));
}

function removeFromContinueWatching(movieId) {
    let list = getContinueWatchingList();
    list = list.filter(item => item.id !== movieId);
    localStorage.setItem(CW_LOCAL_STORAGE_KEY, JSON.stringify(list));
}

function displayContinueWatchingRow() {
    const list = getContinueWatchingList();
    if (list.length > 0) {
        // The list is already sorted by most recent, so just resolve the promise
        createMovieRow("Continue Watching", Promise.resolve(list), { 
            isLarge: true, 
            isContinueWatching: true,
            prepend: true // Add this row at the top
        });
    }
}


// --- EVENT HANDLERS & MODAL LOGIC ---
async function handlePosterClick(event) {
    try {
        const { movieId, mediaType } = event.currentTarget.dataset;
        const details = await fetchMovieDetails(movieId, mediaType);
        if (details) {
            displayModalWithDetails(details, mediaType);
        }
    } catch (error) {
        console.error("Error handling poster click:", error);
    }
}

function handlePosterKeyPress(event) {
    if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault(); // Prevent page from scrolling
        handlePosterClick(event);
    }
}


function displayModalWithDetails(details, mediaType) {
    document.getElementById('modal-title').textContent = details.name || details.title;
    document.getElementById('modal-description').textContent = details.overview;

    const rating = details.vote_average ? ` ${details.vote_average.toFixed(1)}/10` : '';
    const releaseDate = details.release_date || details.first_air_date;
    const releaseYear = releaseDate ? new Date(releaseDate).getFullYear() : '';
    const runtimeValue = details.runtime || (details.episode_run_time ? details.episode_run_time[0] : null);
    const runtime = runtimeValue ? `${runtimeValue} min` : '';

    document.getElementById('modal-rating').textContent = rating;
    document.getElementById('modal-release-date').textContent = releaseYear;
    document.getElementById('modal-runtime').textContent = runtime;

    const modalActions = document.getElementById('modal-actions');
    modalActions.innerHTML = '';    
    
    const trailer = details.videos?.results.find(video => video.site === 'YouTube' && video.type === 'Trailer');
    const initialPlayerType = trailer ? 'trailer' : 'server';
    
    const tvSelectorContainer = document.getElementById('tv-selector-container');
    const seasonSelect = document.getElementById('season-select');
    const episodeSelect = document.getElementById('episode-select');

    const updatePlayerSrc = (serverIndex, season, episode) => {
        const server = SERVERS[serverIndex];
        const type = mediaType === 'tv' ? 'tv' : 'movie';
        vidsrcPlayer.src = server.getUrl(type, details.id, season, episode);
        // NEW: Add item to Continue Watching when a server is selected
        addToContinueWatching(details, mediaType);
    };
    
    const switchToPlayer = (playerType, season = 1, episode = 1) => {
        youtubePlayer.src = '';
        youtubePlayer.classList.add('hidden');
        vidsrcPlayer.src = '';
        vidsrcPlayer.classList.add('hidden');

        if (playerType === 'trailer' && trailer) {
            youtubePlayer.src = `https://www.youtube.com/embed/${trailer.key}?autoplay=1&controls=1&rel=0`;
            youtubePlayer.classList.remove('hidden');
        } else if (playerType === 'server') {
            updatePlayerSrc(activeServerIndex, season, episode);
            vidsrcPlayer.classList.remove('hidden');
        }
    };

    // TV Show Logic
    if (mediaType === 'tv') {
        tvSelectorContainer.classList.remove('hidden');
        seasonSelect.innerHTML = '';
        episodeSelect.innerHTML = '';

        details.seasons.forEach(season => {
            if (season.season_number > 0) { // Exclude "Specials"
                const option = document.createElement('option');
                option.value = season.season_number;
                option.textContent = `Season ${season.season_number}`;
                seasonSelect.appendChild(option);
            }
        });

        const populateEpisodes = async (seasonNumber, isInitialLoad = false) => {
            const seasonDetails = await fetchSeasonDetails(details.id, seasonNumber);
            episodeSelect.innerHTML = '';
            if (seasonDetails?.episodes) {
                seasonDetails.episodes.forEach(episode => {
                    const option = document.createElement('option');
                    option.value = episode.episode_number;
                    option.textContent = `E${episode.episode_number}: ${episode.name}`;
                    episodeSelect.appendChild(option);
                });
                if (episodeSelect.options.length > 0) {
                    episodeSelect.value = episodeSelect.options[0].value;
                    if (isInitialLoad && trailer) {
                        switchToPlayer('trailer');
                    } else {
                        switchToPlayer('server', seasonNumber, episodeSelect.value);
                    }
                }
            }
        };

        seasonSelect.onchange = () => populateEpisodes(seasonSelect.value, false); // Not initial load
        episodeSelect.onchange = () => {
             switchToPlayer('server', seasonSelect.value, episodeSelect.value);
        };

        if (seasonSelect.options.length > 0) {
            populateEpisodes(seasonSelect.value, true); // This is the initial load
        }
    } else { // It's a movie
        tvSelectorContainer.classList.add('hidden');
        if (trailer) {
            switchToPlayer('trailer');
        } else {
            switchToPlayer('server');
        }
    };

    const setActiveButton = (clickedButton) => {
        modalActions.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('bg-red-600');
            btn.classList.add('bg-zinc-700');
        });
        if (clickedButton) {
            clickedButton.classList.remove('bg-zinc-700');
            clickedButton.classList.add('bg-red-600');
        }
    };

    // Create Trailer Button
    if (trailer) {
        const trailerButton = document.createElement('button');
        const isTrailerActive = initialPlayerType === 'trailer';
        trailerButton.className = `text-white font-bold rounded px-4 py-2 hover:bg-zinc-600 transition text-sm ${isTrailerActive ? 'bg-red-600' : 'bg-zinc-700'}`;
        trailerButton.innerHTML = `Trailer`;
        trailerButton.onclick = (e) => {
            switchToPlayer('trailer');
            setActiveButton(e.currentTarget);
        };
        modalActions.appendChild(trailerButton);
    }

    // Create Server Buttons
    SERVERS.forEach((server, index) => {
        const serverButton = document.createElement('button');
        serverButton.dataset.serverIndex = index;
        const isServerActive = initialPlayerType === 'server' && index === activeServerIndex;
        serverButton.className = `server-btn text-white font-bold rounded px-4 py-2 hover:bg-zinc-600 transition text-sm ${isServerActive ? 'bg-red-600' : 'bg-zinc-700'}`;
        serverButton.textContent = server.name;
        serverButton.onclick = (e) => {
            activeServerIndex = parseInt(e.currentTarget.dataset.serverIndex);
            
            const currentSeason = mediaType === 'tv' ? seasonSelect.value : 1;
            const currentEpisode = mediaType === 'tv' ? episodeSelect.value : 1;
            switchToPlayer('server', currentSeason, currentEpisode);
            setActiveButton(e.currentTarget);
        };
        modalActions.appendChild(serverButton);
    });
    
    document.body.style.overflow = 'hidden';
    modalOverlay.classList.remove('hidden');
}

function closeModal() {
    document.body.style.overflow = 'auto';
    modalOverlay.classList.add('hidden');
    youtubePlayer.src = '';
    vidsrcPlayer.src = '';
    document.getElementById('tv-selector-container').classList.add('hidden');
    document.getElementById('season-select').innerHTML = '';
    document.getElementById('episode-select').innerHTML = '';
}

// --- BANNER CAROUSEL FUNCTIONS ---
function updateBannerSlide(index, isManualClick = false) {
    if (isManualClick) {
        clearInterval(bannerInterval);
    }
    
    currentBannerIndex = index;
    const movie = bannerCarouselMovies[currentBannerIndex];

    if (!movie) return;

    bannerContentWrapper.style.opacity = '0';

    document.querySelectorAll('.banner-dot').forEach((dot, idx) => {
        dot.classList.toggle('active', idx === currentBannerIndex);
    });

    setTimeout(() => {
        banner.style.backgroundImage = `url('${IMAGE_BASE_URL_BACKDROP}${movie.backdrop_path}')`;
        
        document.getElementById('banner-title').textContent = movie.name || movie.title || movie.original_name;
        document.getElementById('banner-description').textContent = movie.overview;

        const bannerPlayBtn = document.getElementById('banner-play-btn');
        const bannerInfoBtn = document.getElementById('banner-info-btn');

        const newPlayBtn = bannerPlayBtn.cloneNode(true);
        const newInfoBtn = bannerInfoBtn.cloneNode(true);

        const showModalForCurrentBanner = async () => {
            try {
                const mediaType = movie.media_type || 'tv'; // Default to 'tv' as originals are TV
                const details = await fetchMovieDetails(movie.id, mediaType);
                if (details) displayModalWithDetails(details, mediaType);
            } catch (e) {
                console.error("Could not load banner modal details:", e);
            }
        };

        newPlayBtn.addEventListener('click', showModalForCurrentBanner);
        newInfoBtn.addEventListener('click', showModalForCurrentBanner);
        
        bannerPlayBtn.replaceWith(newPlayBtn);
        bannerInfoBtn.replaceWith(newInfoBtn);
        
        bannerContentWrapper.style.opacity = '1';

    }, 500); // This duration should match the opacity transition duration

    if (isManualClick) {
        bannerInterval = setInterval(() => {
            const nextIndex = (currentBannerIndex + 1) % bannerCarouselMovies.length;
            updateBannerSlide(nextIndex);
        }, 7000);
    }
}

function setupBannerCarousel() {
    clearInterval(bannerInterval);
    bannerDotsContainer.innerHTML = '';

    bannerCarouselMovies.forEach((_, index) => {
        const dot = document.createElement('button');
        dot.className = 'banner-dot';
        dot.setAttribute('aria-label', `Go to slide ${index + 1}`);
        dot.addEventListener('click', () => updateBannerSlide(index, true));
        bannerDotsContainer.appendChild(dot);
    });

    updateBannerSlide(0);

    bannerInterval = setInterval(() => {
        const nextIndex = (currentBannerIndex + 1) % bannerCarouselMovies.length;
        updateBannerSlide(nextIndex);
    }, 7000);
}


// --- INITIALIZATION & PAGE LOGIC ---
const allRows = [
    { title: "DexFlix Originals (TV)", endpoint: requests.fetchNetflixOriginals, options: { isLarge: true } },
    { title: "Trending Now", endpoint: requests.fetchTrending },
    { title: "Top Rated Movies", endpoint: requests.fetchTopRated },
    { title: "Action & Adventure (TV)", endpoint: requests.fetchTvShows },
    { title: "Action Movies", endpoint: requests.fetchActionMovies },
    { title: "Animation Movies", endpoint: requests.fetchAnimationMovies },
    { title: "Comedy Movies", endpoint: requests.fetchComedyMovies },
    { title: "Horror Movies", endpoint: requests.fetchHorrorMovies },
    { title: "Thriller Movies", endpoint: requests.fetchThrillerMovies },
    { title: "Romance Movies", endpoint: requests.fetchRomanceMovies },
    { title: "Sci-Fi Movies", endpoint: requests.fetchSciFiMovies },
    { title: "Documentaries", endpoint: requests.fetchDocumentaries },
];

async function initializeHomepageContent() {
    try {
        // NEW: Display the Continue Watching row first from local storage
        displayContinueWatchingRow();
    
        const bannerMoviesPromise = fetchData(requests.fetchNetflixOriginals);
        const rowPromises = allRows.map(rowConfig =>
            createMovieRow(rowConfig.title, fetchData(rowConfig.endpoint), rowConfig.options)
        );

        const bannerMovies = await bannerMoviesPromise;
        if(bannerMovies && bannerMovies.length > 0) {
            bannerCarouselMovies = bannerMovies
                .sort((a, b) => b.popularity - a.popularity)
                .slice(0, 5)
                .sort(() => 0.5 - Math.random());
            
            if (bannerCarouselMovies.length > 0) {
                setupBannerCarousel();
            }
        }

        await Promise.all(rowPromises);
    } catch (error) {
        console.error("Failed to initialize homepage:", error);
        movieRowsContainer.innerHTML = `<div class="p-8 text-center"><h2 class="2xl font-bold text-red-500">Failed to Load Content</h2><p class="mt-2 text-gray-300">Please check your internet connection and try refreshing the page.</p></div>`;
    }
}

async function performSearch(query) {
    if (!query) return;
    banner.style.display = 'none';
    clearInterval(bannerInterval); 
    bannerContentWrapper.style.opacity = '0';
    bannerDotsContainer.innerHTML = '';


    movieRowsContainer.innerHTML = `<div class="my-8"><h2 class="text-xl md:text-2xl font-bold mb-2">Searching for "${query}"...</h2></div>`;
    
    try {
        const searchEndpoint = `/search/multi?api_key=${API_KEY}&language=en-US&query=${encodeURIComponent(query)}&page=1&include_adult=false`;
        const results = await fetchData(searchEndpoint);
        
        movieRowsContainer.innerHTML = ''; // Clear loading message
        const filteredResults = results ? results.filter(item => item.media_type !== 'person' && (item.backdrop_path || item.poster_path)) : [];

        if (filteredResults.length > 0) {
            const title = `Search Results for "${query}"`;
            createMovieRow(title, Promise.resolve(filteredResults));

            setTimeout(() => {
                const rowTitle = Array.from(document.querySelectorAll('#movie-rows h2')).find(h2 => h2.textContent.startsWith('Search Results'));
                if (rowTitle) {
                    rowTitle.classList.add('flex', 'items-center', 'gap-4');
                    const clearButton = document.createElement('button');
                    clearButton.textContent = 'Clear';
                    clearButton.className = 'bg-zinc-700 text-white font-semibold rounded px-3 py-1 hover:bg-zinc-600 transition text-xs';
                    clearButton.setAttribute('aria-label', 'Clear search results and return to homepage');
                    clearButton.onclick = () => logo.click();
                    rowTitle.appendChild(clearButton);
                }
            }, 200);

        } else {
            movieRowsContainer.innerHTML = `<h2 class="text-xl md:text-2xl font-bold my-8">No results found for "${query}"</h2>`;
        }
    } catch (error) {
        console.error("Error during search:", error);
        movieRowsContainer.innerHTML = `<div class="p-8 text-center"><h2 class="text-2xl font-bold text-red-500">Search Failed</h2><p class="mt-2 text-gray-300">An error occurred. Please try again.</p></div>`;
    }
}


document.addEventListener('DOMContentLoaded', () => {
    const preloader = document.getElementById('preloader');

    initializeHomepageContent().finally(() => {
        preloader.classList.add('hidden');
    });

    searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        performSearch(searchInput.value.trim());
    });

    searchToggleBtn.addEventListener('click', () => {
        searchForm.classList.toggle('hidden');
        searchForm.classList.toggle('absolute');
        searchForm.classList.toggle('right-2');
        searchInput.classList.toggle('w-48');
        if(!searchForm.classList.contains('hidden')) {
             searchInput.focus();
        }
    });

    logo.addEventListener('click', (e) => {
        e.preventDefault();
        if (banner.style.display !== 'none' && !searchInput.value) return;

        banner.style.display = 'block';
        movieRowsContainer.innerHTML = '';
        searchInput.value = '';
        preloader.classList.remove('hidden'); // Show preloader again
        initializeHomepageContent().finally(() => {
            preloader.classList.add('hidden');
        });
    });

    modalCloseBtn.addEventListener('click', closeModal);
    
    window.addEventListener('scroll', () => {
        const navbar = document.getElementById('navbar');
        navbar.style.backgroundColor = window.scrollY > 100 ? '#141414' : 'transparent';
    });

    // --- Fullscreen Button Logic ---
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const playerWrapper = document.getElementById('player-wrapper');
    const enterFullscreenIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5" /></svg> Full Screen`;
    const exitFullscreenIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4h5v5m0-5l-6 6m-6 6H4v-5m0 5l6-6" /></svg> Exit Full Screen`;

    fullscreenBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
            playerWrapper.requestFullscreen().catch(err => {
                console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    });

    document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
            fullscreenBtn.innerHTML = exitFullscreenIcon;
            try {
                if (screen.orientation && typeof screen.orientation.lock === 'function') {
                    screen.orientation.lock('landscape').catch(err => {
                        console.log("Could not lock screen orientation: ", err);
                    });
                }
            } catch (e) {
                console.error("Screen orientation lock failed:", e);
            }
        } else {
            fullscreenBtn.innerHTML = enterFullscreenIcon;
            try {
                if (screen.orientation && typeof screen.orientation.unlock === 'function') {
                    screen.orientation.unlock();
                }
            } catch (e) {
                console.error("Screen orientation unlock failed:", e);
            }
        }
    });
    // --- End Fullscreen Button Logic ---

    // Dynamically update footer year
    const yearSpan = document.getElementById('current-year');
    if (yearSpan) {
        yearSpan.textContent = new Date().getFullYear();
    }
});

</script>
    
<!-- IMPROVEMENT: Re-styled footer with Tailwind CSS and better structure for readability --><footer class="bg-black text-white text-xs text-center p-5">
    <div class="max-w-4xl mx-auto space-y-4">
        <p>Â© <span id="current-year"></span> DexFlix</p>
        <p class="text-gray-400 italic">Disclaimer: I do not own or host any of the videos streamed on this site. The links provided were found publicly available through Google search and are shared here for convenience only. If you are the rightful copyright holder and wish to have any content removed, please contact me at the below link, and I will promptly take action.</p>
        <p><a href="https://forms.gle/otJ17bAKZ6K5uXU69" target="_blank" class="text-red-500 hover:underline">Contact Me</a></p>
    </div>
</footer>
    
</body>
</html>

