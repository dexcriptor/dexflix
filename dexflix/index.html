<!DOCTYPE html>
<html lang="en">

<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dex Online TV</title>
    <!-- Kept for verification/analytics -->
    <script async src="f0a6f.txt" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com/"></script>
    
    <link href="all.min.css" rel="stylesheet">
    <link href="homebutton.css" rel="stylesheet">
    
    <!-- Custom scrollbar for webkit to match dark theme -->
    <style>
        /* Global Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f0f0f; 
        }
        ::-webkit-scrollbar-thumb {
            background: #333; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }

        /* Specific styles for the channel list to ensure it looks contained */
        .channel-list-container {
            scrollbar-width: thin;
            scrollbar-color: #333 #0f0f0f;
        }
    </style>
</head>
<body class="bg-[#141414] text-gray-100 font-sans antialiased min-h-screen flex flex-col selection:bg-red-900 selection:text-white">

    <!-- Navbar / Header -->
    <nav class="bg-[#0a0a0a] border-b border-gray-800 sticky top-0 z-50 backdrop-blur-sm bg-opacity-90">
        <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
           <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-red-600 rounded flex items-center justify-center shadow-lg shadow-red-900/50">
                <i class="fas fa-play text-white text-xs"></i>
              </div>
              <h1 class="text-lg md:text-xl font-bold tracking-tight text-white">Dex <span class="text-gray-500 font-normal">Online TV</span></h1>
           </div>
           <div class="flex items-center gap-2 px-3 py-1 bg-gray-900 rounded-full border border-gray-800">
              <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div> 
              <span class="text-xs font-bold text-gray-300 tracking-wider">LIVE</span>
           </div>
        </div>
    </nav>

    <!-- Main Interface -->
    <main class="flex-grow pt-6 pb-8 px-4 md:px-6">
        
        <!-- Changed grid to flex-col for mobile, kept grid for lg screens -->
        <div class="max-w-[1600px] mx-auto flex flex-col lg:grid lg:grid-cols-3 gap-6 lg:gap-8">
            
            <!-- LEFT COLUMN: Video Player & Fullscreen Button -->
            <!-- Sticky behavior ensures both player and button stick on mobile -->
            <div class="lg:col-span-2 flex flex-col gap-4 sticky top-20 z-40 bg-[#141414] pb-4 lg:pb-0 lg:static lg:bg-transparent shadow-lg lg:shadow-none border-b lg:border-none border-gray-800">
                <!-- Wrapper to keep player sticky on desktop if content gets long -->
                <div class="lg:sticky lg:top-24 flex flex-col gap-4">
                    <div class="relative w-full bg-black rounded-xl overflow-hidden shadow-2xl shadow-black border border-gray-800 aspect-video z-10">
                        <!-- Player Placeholder / Injection Point -->
                        <div id="player" class="w-full h-full"></div>
                    </div>

                    <!-- Full Screen Button (Moved here) -->
                    <button id="fullscreenBtn" onclick="toggleFullScreen()" class="w-full py-3 bg-gray-800 hover:bg-red-600 text-white rounded-lg border border-gray-700 hover:border-red-500 transition-all duration-300 flex items-center justify-center gap-2 group shadow-lg cursor-pointer">
                        <i class="fas fa-expand group-hover:scale-110 transition-transform"></i>
                        <span class="font-medium text-sm">Full Screen</span>
                    </button>
                </div>
            </div>

            <!-- RIGHT COLUMN: Sidebar (Channel List Only) -->
            <div class="lg:col-span-1 flex flex-col gap-4 h-[calc(100vh-320px)] lg:h-[calc(100vh-100px)] min-h-[400px]">
                
                <!-- Channel List Container (Scrollable) -->
                <div class="bg-[#1a1a1a] rounded-xl border border-gray-800 shadow-lg flex flex-col flex-grow overflow-hidden">
                    <!-- Header with Search -->
                    <div class="p-3 bg-[#1f1f1f] border-b border-gray-700 flex items-center justify-between shrink-0">
                        <!-- Removed 'hidden sm:flex' to show on mobile -->
                        <span class="text-gray-200 font-semibold text-sm flex items-center gap-2">
                            <i class="fas fa-list text-gray-500"></i> Channels
                        </span>
                        
                        <!-- Search Input -->
                        <!-- Adjusted classes to share width on mobile: removed w-full, added flex-1 and ml-2 -->
                        <div class="relative flex-1 sm:flex-none sm:w-auto ml-2 sm:ml-0">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-xs"></i>
                            <input type="text" id="channelSearch" placeholder="Search channels..." class="w-full sm:w-48 bg-black text-gray-300 text-xs rounded border border-gray-800 py-2 pl-8 pr-8 focus:outline-none focus:border-red-600 transition-colors placeholder-gray-600">
                            <!-- Clear Button -->
                            <button id="clearSearchBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-white hidden focus:outline-none transition-colors">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Scrollable List Area -->
                    <div id="channelList" class="flex-grow overflow-y-auto p-2 space-y-1 channel-list-container">
                        <!-- Buttons injected by JS -->
                        <div class="text-gray-500 text-center py-4 text-sm animate-pulse">Loading channels...</div>
                    </div>
                </div>

            </div>

        </div>
        
        <!-- Footer Credit -->
        <div class="text-center mt-8 pb-4 text-gray-600 text-xs flex items-center justify-center gap-2">
            <i class="fas fa-shield-alt"></i> Secure Stream &copy; 2024 Kaijo
        </div>
        
    </main>

    <script>
        // Encoded Resources
        const _0x1 = [
            'jwpsrv.js', 'jwplayer.js', 'aHR0cHM6Ly9kZXhmbGl4LnBhZ2VzLmRldi9jaGFubmVscy5qcw=='
        ];
        
        const _0x2 = 'WFN1UDRxTWwrOXRLMTdRTmIrNCt0aDJQbTlBV2dNTy9jWUg4Q0kwSEdHcjdiZGpv';

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function initApp() {
            try {
                await loadScript(_0x1[0]);
                await loadScript(_0x1[1]);
                await loadScript(atob(_0x1[2]));
                jwplayer[atob('a2V5')] = atob(_0x2);
                
                let currentActiveKey = null;
                let channelStatus = {};

                // Function to detect iOS devices
                function isIOS() {
                    return [
                        'iPad Simulator', 'iPhone Simulator', 'iPod Simulator', 'iPad', 'iPhone', 'iPod'
                    ].includes(navigator.platform)
                    || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
                }

                // Check URL Status with DRM and Key Validation
                async function checkChannelStatus(channel) {
                    try {
                        let url = channel.url;
                        if (isIOS() && channel.iosUrl) {
                            url = channel.iosUrl;
                        }

                        const controller = new AbortController();
                        // 5 second timeout to allow content download
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        
                        const response = await fetch(url, { 
                            method: 'GET', 
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);

                        if (!response.ok) return false;

                        // Deep inspection to confirm playability
                        const text = await response.text();
                        const lowerText = text.toLowerCase();
                        
                        // DASH Check: Must have MPD xml tag
                        if (url.includes('.mpd') || channel.type === 'mpd') {
                            const isValidMpd = text.includes('<MPD') || text.includes('urn:mpeg:dash');
                            if (!isValidMpd) return false;

                            // Check for DRM protection signals
                            const isProtected = text.includes('ContentProtection') || text.includes('cenc:pssh');
                            
                            // If protected, we ensure keys are present AND match content
                            if (isProtected) {
                                if (!channel.key || !channel.keyId) {
                                    return false; // Offline: Protected stream but no keys provided
                                }

                                // Verify if the Provided Key ID exists in the manifest
                                // 1. Normalize config Key ID (remove dashes, lowercase)
                                const configKidClean = channel.keyId.toLowerCase().replace(/-/g, '');
                                
                                // 2. Create dashed version (Standard UUID: 8-4-4-4-12)
                                const configKidDashed = configKidClean.replace(/(.{8})(.{4})(.{4})(.{4})(.{12})/, '$1-$2-$3-$4-$5');

                                // 3. Search for either format in the manifest
                                // This confirms the Key ID in config matches the one requested by the stream (cenc:default_KID)
                                if (!lowerText.includes(configKidClean) && !lowerText.includes(configKidDashed)) {
                                    // Offline: Key ID mismatch. The stream is online, but the provided key is wrong.
                                    return false; 
                                }
                            }
                            
                            return true;
                        }
                        
                        // HLS Check: Must have M3U header
                        if (url.includes('.m3u8') || url.includes('.m3u') || channel.type === 'hls') {
                            return text.includes('#EXTM3U');
                        }

                        return true;
                    } catch (error) {
                        return false;
                    }
                }

                // Iterate and update all channel statuses
                async function updateAllChannelStatuses() {
                    if (typeof channels === 'undefined') return;

                    const keys = Object.keys(channels);
                    
                    // We process checks in parallel
                    const checks = keys.map(async (key) => {
                        const channel = channels[key];
                        
                        // Pass full channel object to check DRM status
                        const isOnline = await checkChannelStatus(channel);
                        channelStatus[key] = isOnline;

                        // Update the specific icon if it exists in DOM
                        const icon = document.getElementById('status-' + key);
                        if (icon) {
                            // Remove Loading State
                            icon.classList.remove('text-gray-500', 'animate-pulse');
                            
                            if (isOnline) {
                                icon.classList.add('text-green-500');
                            } else {
                                icon.classList.add('text-red-500');
                            }
                        }
                    });

                    await Promise.allSettled(checks);
                }

                // Setup Fullscreen Toggle
                window.toggleFullScreen = function() {
                    const player = jwplayer("player");
                    if (player && typeof player.setFullscreen === 'function') {
                        player.setFullscreen(true);
                    } else {
                        const elem = document.getElementById("player");
                        if (elem.requestFullscreen) elem.requestFullscreen();
                        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                        else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
                    }
                };

                // Load Stream Logic
                window.loadStream = function(channelKey) {
                    currentActiveKey = channelKey; // Set active key

                    if (typeof channels === 'undefined') return;
                    const channel = channels[channelKey];
                    if (!channel) return;

                    // Update UI Active State
                    document.querySelectorAll('.channel-btn').forEach(btn => {
                        btn.classList.remove('bg-red-600', 'text-white', 'border-red-500');
                        btn.classList.add('bg-[#252525]', 'text-gray-300', 'border-transparent', 'hover:bg-[#333]');
                    });
                    const activeBtn = document.getElementById('btn-' + channelKey);
                    if(activeBtn) {
                        activeBtn.classList.remove('bg-[#252525]', 'text-gray-300', 'border-transparent', 'hover:bg-[#333]');
                        activeBtn.classList.add('bg-red-600', 'text-white', 'border-red-500');
                    }

                    let fileUrl = channel.url;
                    let fileType = channel.type;
                    let drmConfig = undefined;

                    if (isIOS()) {
                        if (channel.iosUrl) {
                            fileUrl = channel.iosUrl;
                            fileType = 'hls';
                        } else if (channel.type === 'mpd') {
                            alert("Channel Unavailable on iOS: This channel uses technology (MPEG-DASH) not supported by Apple devices.");
                            return; 
                        }
                    }

                    if (fileType === 'mpd' && channel.keyId && channel.key) {
                        drmConfig = {
                            clearkey: {
                                keyId: channel.keyId,
                                key: channel.key
                            }
                        };
                    }

                    jwplayer("player").setup({
                        file: fileUrl,
                        type: fileType,
                        drm: drmConfig,
                        width: "100%",
                        aspectratio: "16:9",
                        autostart: true,
                        androidhls: true,
                        primary: 'html5' 
                    });
                };

                // Function to Render Channel List (with optional filter)
                function renderChannelList(filter = '') {
                    const listContainer = document.getElementById('channelList');
                    if (typeof channels === 'undefined') return;
                    
                    listContainer.innerHTML = ''; 
                    const lowerFilter = filter.toLowerCase();
                    let hasMatch = false;

                    Object.keys(channels).forEach(key => {
                        const channel = channels[key];
                        const channelName = channel.name;
                        
                        // Filter Logic
                        if (!channelName.toLowerCase().includes(lowerFilter)) return;

                        hasMatch = true;
                        const btn = document.createElement('button');
                        btn.id = 'btn-' + key;
                        
                        // Check if this is the currently playing channel
                        const isActive = (key === currentActiveKey);
                        const baseClasses = 'channel-btn w-full text-left px-4 py-3 rounded-lg border transition-all duration-200 flex items-center gap-3 group focus:outline-none';
                        const activeClasses = 'bg-red-600 text-white border-red-500';
                        const inactiveClasses = 'bg-[#252525] text-gray-300 border-transparent hover:bg-[#333]';

                        btn.className = `${baseClasses} ${isActive ? activeClasses : inactiveClasses}`;
                        
                        // Icon
                        const icon = document.createElement('div');
                        icon.className = 'w-8 h-8 rounded-full bg-black flex items-center justify-center text-gray-500 group-hover:text-white transition-colors text-xs shrink-0';
                        icon.innerHTML = '<i class="fas fa-tv"></i>';
                        
                        // Text
                        const text = document.createElement('span');
                        text.className = 'font-medium text-sm truncate flex-1 min-w-0'; // flex-1 allows it to take space, min-w-0 allows truncate
                        text.textContent = channelName;

                        // Format Indicator
                        let formatText = '';
                        let formatClass = 'text-[10px] font-bold px-1 ml-2 shrink-0 border rounded ';
                        
                        const url = (channel.url || '').toLowerCase();
                        const type = (channel.type || '').toLowerCase();

                        if (type === 'hls' || url.includes('.m3u8') || url.includes('.m3u')) {
                            formatText = 'HLS';
                            formatClass += 'text-blue-400 border-blue-900 bg-blue-900/20'; // Light Blue style
                        } else if (type === 'mpd' || url.includes('.mpd')) {
                            formatText = 'DASH';
                            formatClass += 'text-green-400 border-green-900 bg-green-900/20'; // Light Green style
                        }

                        btn.appendChild(icon);
                        btn.appendChild(text);

                        // Append Format Badge
                        if (formatText) {
                            const formatBadge = document.createElement('span');
                            formatBadge.className = formatClass;
                            formatBadge.textContent = formatText;
                            btn.appendChild(formatBadge);
                        }

                        // Append Status Icon (Online/Offline)
                        const statusIcon = document.createElement('i');
                        statusIcon.id = 'status-' + key;
                        let statusClass = 'fas fa-circle text-[10px] ml-2 shrink-0 ';
                        
                        // Check status cache
                        if (channelStatus[key] === true) {
                            statusClass += 'text-green-500'; // Online
                        } else if (channelStatus[key] === false) {
                            statusClass += 'text-red-500'; // Offline
                        } else {
                            statusClass += 'text-gray-500 animate-pulse'; // Loading/Unknown
                        }
                        
                        statusIcon.className = statusClass;
                        btn.appendChild(statusIcon);

                        btn.onclick = function() {
                            loadStream(key);
                        };

                        listContainer.appendChild(btn);
                    });

                    // Empty State
                    if (!hasMatch) {
                        listContainer.innerHTML = `
                            <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                                <i class="fas fa-search-minus text-2xl mb-2 opacity-50"></i>
                                <span class="text-sm">No channels found</span>
                            </div>
                        `;
                    }
                }

                // Initial Render
                renderChannelList();

                // Trigger Background Status Check
                updateAllChannelStatuses();

                // Setup Search Listener
                const searchInput = document.getElementById('channelSearch');
                const clearBtn = document.getElementById('clearSearchBtn');

                if (searchInput) {
                    searchInput.addEventListener('input', function(e) {
                        const val = e.target.value;
                        renderChannelList(val);
                        // Toggle clear button
                        if (val.length > 0) {
                            clearBtn.classList.remove('hidden');
                        } else {
                            clearBtn.classList.add('hidden');
                        }
                    });
                }
                
                if (clearBtn && searchInput) {
                    clearBtn.addEventListener('click', function() {
                        searchInput.value = '';
                        renderChannelList('');
                        clearBtn.classList.add('hidden');
                        searchInput.focus();
                    });
                }

                // Hide Full Screen on iOS
                if (isIOS()) {
                    const fsBtn = document.getElementById('fullscreenBtn');
                    if (fsBtn) fsBtn.style.display = 'none';
                }

            } catch (error) {
                console.error("Error loading resources:", error);
            }
        }

        // Start initialization
        initApp();
    </script>

</body>
</html>
